from datetime import datetime
from typing import Optional, List, Callable
import requests
import pytz
import json

from vnpy.trader.datafeed import BaseDatafeed
from vnpy.trader.setting import SETTINGS
from vnpy.trader.constant import Interval
from vnpy.trader.object import BarData, HistoryRequest

INTERVAL_VT2CA = {
    Interval.MINUTE: "1MIN",
    Interval.MINUTE15: "15MIN",
    Interval.HOUR: "1HRS",
    Interval.DAILY: "1DAY",
    Interval.TICK: 0
}

UTC_TZ = pytz.utc
COINAPI_HOST = "https://rest.coinapi.io/jsonrpc"


class CoinapiDatafeed(BaseDatafeed):
    """CoinAPI数据服务接口（JSON-RPC）"""

    def __init__(self):
        """初始化，读取 API 密钥"""
        self.password: str = SETTINGS["datafeed.password"]

    def to_ca_symbol(symbol, exchange):
        """将交易所代码转换为CoinAPI代码 OKEX_SPOT_BTC_USDT"""
        return f"{exchange.value}_SPOT_{symbol}".upper()
    #
    # def to_ca_symbol2(self, symbol: str, exchange: str) -> Optional[str]:
    #     """根据交易所和symbol查询symbol_id"""
    #     url = COINAPI_HOST
    #     headers = {'X-CoinAPI-Key': self.password, 'Content-Type': 'application/json'}
    #
    #     # 确保exchange和symbol为字符串类型
    #     exchange = str(exchange)
    #     symbol = str(symbol)
    #
    #     data = {
    #         "jsonrpc": "2.0",
    #         "method": "v1/symbols",
    #         "params": [
    #             {"exchange_id": exchange},  # 过滤交易所
    #             {"filter_symbol_id": f"{exchange}_"},  # 过滤symbol_id
    #             {"filter_asset_id": symbol}  # 过滤基础资产
    #         ],
    #         "id": "my-tracking-id-001"
    #     }
    #
    #     try:
    #         # 发起请求
    #         response = requests.post(url, headers=headers, data=json.dumps(data))
    #
    #         if response.status_code != 200:
    #             print(f"Error: {response.status_code}")
    #             return None
    #
    #         # 解析返回的symbol列表
    #         symbols = response.json().get("result", [])
    #
    #         print("所有符号数据:", symbols)
    #
    #         # 匹配交易所和符号，返回symbol_id
    #         for s in symbols:
    #             if s['exchange_id'] == exchange:  # and s['asset_id_base'] == symbol
    #                 return s['symbol_id']
    #
    #         print(f"未找到symbol_id，symbol: {symbol}，exchange: {exchange}")
    #         return None
    #
    #     except requests.exceptions.RequestException as e:
    #         print(f"请求错误: {e}")
    #         return None
    #     except Exception as e:
    #         print(f"发生异常: {e}")
    #         return None

    def query_bar_history(self, req: HistoryRequest, output: Callable = print) -> Optional[List[BarData]]:
        print(">>>>>>>>>>>>>>>>>>>>>>coinapi>>>>>>>>>>>>>>>>>>>>>>>>>>>")
        """查询 K 线数据"""
        symbol = req.symbol
        exchange = req.exchange
        interval = req.interval
        start = req.start
        end = req.end

        # 构建 JSON-RPC 请求参数
        # 获取symbol_id
        symbol_id = "OKEX_SPOT_BTC_USDT" # self.to_ca_symbol(symbol, exchange)
        if not symbol_id:
            output(f"无法找到symbol_id: {symbol} {exchange}")
            return None

        print("INTERVAL_VT2CA[interval]:", INTERVAL_VT2CA[interval])
        period_id = "15MIN" #INTERVAL_VT2CA[interval]
        time_start = start.strftime("%Y-%m-%dT%H:%M:%S")
        time_end = end.strftime("%Y-%m-%dT%H:%M:%S")

        # json_payload = {
        #     "jsonrpc": "2.0",
        #     "method": "v1/ohlcv/{symbol_id}/history".format(symbol_id=symbol_id),
        #     "params": {
        #         "period_id": period_id,
        #         "time_start": time_start,
        #         "time_end": time_end
        #     },
        #     "id": "query_bar_history"
        # }
        #
        # headers = {'X-CoinAPI-Key': self.password, 'Content-Type': 'application/json'}

        # 构建 URL
        url = (
            f"https://rest.coinapi.io/v1/ohlcv/{symbol_id}/history"
            f"?period_id={period_id}&time_start={time_start}&time_end={time_end}&limit=10000"
        )

        # 构建请求头
        headers = {"X-CoinAPI-Key": self.password}

        try:
            # response = requests.post(
            #     url=COINAPI_HOST,
            #     headers=headers,
            #     json=json_payload  # 直接传递json字典
            # )
            response = requests.get(url, headers=headers)

            # 检查响应状态
            if response.status_code != 200:
                output(f"请求失败: {response.text}")
                return None

            response_data = response.json()

            # 错误处理
            if "error" in response_data:
                output(f"错误: {response_data['error']['message']}")
                return None

            # 解析结果数据
            bars: List[BarData] = []
            for d in response_data: #response_data["result"]:
                dt = datetime.strptime(d["time_period_start"], "%Y-%m-%dT%H:%M:%S.%f0Z")
                dt = UTC_TZ.localize(dt)

                bar = BarData(
                    symbol=symbol,
                    exchange=exchange,
                    interval=interval,
                    datetime=dt,
                    open_price=d["price_open"],
                    high_price=d["price_high"],
                    low_price=d["price_low"],
                    close_price=d["price_close"],
                    volume=d["volume_traded"],
                    gateway_name="CA",
                )
                bars.append(bar)

            return bars

        except Exception as e:
            output(f"请求异常: {str(e)}")
            return None

"""
1.
curl -X POST "https://rest.coinapi.io/jsonrpc/apikey-dae693cd-81e1-4e30-869b-90e3fe1bd80d" \
-H "Content-Type: application/json" \
-d '{
  "jsonrpc": "2.0",
  "method": "v1/symbols",
  "params": [
    {"exchange_id": "OKEX"},
    {"filter_symbol_id": "OKEX_"},
    {"filter_asset_id": "BTC"}
  ],
  "id": "my-tracking-id-001"
}'


RESPONSE:

{
  "jsonrpc": "2.0",
  "result": [
    {
      "symbol_id": "OKEX_SPOT_BTC_USDT",
      "exchange_id": "OKEX",
      "symbol_type": "SPOT",
      "asset_id_base": "BTC",
      "asset_id_quote": "USDT",
      "data_start": "2017-12-18",
      "data_end": "2024-12-15",
      "data_quote_start": "2017-12-18T00:00:00.0000000Z",
      "data_quote_end": "2024-12-15T00:00:00.0000000Z",
      "data_orderbook_start": "2017-12-18T21:01:54.6760007Z",
      "data_orderbook_end": "2023-07-06T00:00:00.0000000Z",
      "data_trade_start": "2017-12-18T00:00:00.0000000Z",
      "data_trade_end": "2024-12-15T00:00:00.0000000Z",
      "volume_1hrs": 115.13101716,
      "volume_1hrs_usd": 12069095.6,
      "volume_1day": 5651.51061393,
      "volume_1day_usd": 592443492.37,
      "volume_1mth": 264217.47314012,
      "volume_1mth_usd": 27697713624.63,
      "price": 104848.05,
      "symbol_id_exchange": "BTC-USDT",
      "asset_id_base_exchange": "BTC",
      "asset_id_quote_exchange": "USDT",
      "price_precision": 0.100000000,
      "size_precision": 0.000000010,
      "volume_to_usd": 104829.2275883675417055
    },

2.
curl -L 'https://rest.coinapi.io/v1/symbols?filter_exchange_id=OKEX&filter_symbol_id=BTC' \
-H 'Accept: text/plain' \
-H 'X-CoinAPI-Key: dae693cd-81e1-4e30-869b-90e3fe1bd80d' \
-o coinapi_symbols2.json

"""
